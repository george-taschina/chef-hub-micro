apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-alerts
  namespace: chefhub-observability
data:
  alerts.yml: |
    groups:
      - name: service-health
        rules:
          - alert: ServiceDown
            expr: up{job=~".*-service"} == 0
            for: 1m
            labels:
              severity: critical
            annotations:
              summary: "Service {{ $labels.job }} is down"
              description: "{{ $labels.instance }} has been down for more than 1 minute"

          - alert: HighErrorRate
            expr: |
              sum(rate(http_requests_total{status=~"5.."}[5m])) by (service)
              /
              sum(rate(http_requests_total[5m])) by (service)
              > 0.05
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High error rate in {{ $labels.service }}"
              description: "Error rate is {{ humanizePercentage $value }}"

          - alert: HighLatencyP95
            expr: |
              histogram_quantile(0.95,
                sum(rate(http_request_duration_seconds_bucket[5m])) by (le, service)
              ) > 2
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High latency in {{ $labels.service }}"
              description: "95th percentile latency is {{ $value }}s"

          - alert: PodCrashLooping
            expr: |
              increase(kube_pod_container_status_restarts_total[1h]) > 3
            labels:
              severity: warning
            annotations:
              summary: "Pod {{ $labels.pod }} is crash looping"
